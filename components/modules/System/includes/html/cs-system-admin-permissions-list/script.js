// Generated by CoffeeScript 1.9.3

/**
 * @package    CleverStyle CMS
 * @subpackage System module
 * @category   modules
 * @author     Nazar Mokrynskyi <nazar@mokrynskyi.com>
 * @copyright  Copyright (c) 2015-2016, Nazar Mokrynskyi
 * @license    MIT License, see license.txt
 */

(function() {
  var L;

  L = cs.Language;

  Polymer({
    'is': 'cs-system-admin-permissions-list',
    behaviors: [cs.Polymer.behaviors.Language],
    properties: {
      permissions: []
    },
    ready: function() {
      return this.reload();
    },
    reload: function() {
      return Promise.all([$.getJSON('api/System/admin/blocks'), $.getJSON('api/System/admin/permissions')]).then((function(_this) {
        return function(arg) {
          var block_index_to_title, blocks, group, id, label, labels, permissions, permissions_list;
          blocks = arg[0], permissions = arg[1];
          block_index_to_title = {};
          blocks.forEach(function(block) {
            return block_index_to_title[block.index] = block.title;
          });
          permissions_list = [];
          for (group in permissions) {
            labels = permissions[group];
            for (label in labels) {
              id = labels[label];
              permissions_list.push({
                id: id,
                group: group,
                label: label,
                description: group === 'Block' ? block_index_to_title[label] : ''
              });
            }
          }
          return _this.set('permissions', permissions_list);
        };
      })(this));
    },
    add_permission: function() {
      return $(cs.ui.simple_modal("<h3>" + L.adding_permission + "</h3>\n<p class=\"cs-block-error cs-text-error\">" + L.changing_settings_warning + "</p>\n<cs-system-admin-permissions-form/>")).on('close', (function(_this) {
        return function() {
          return _this.reload();
        };
      })(this));
    },
    edit_permission: function(e) {
      var permission;
      permission = e.model.permission;
      return $(cs.ui.simple_modal("<h3>" + (L.editing_permission(permission.group + '/' + permission.label)) + "</h3>\n<p class=\"cs-block-error cs-text-error\">" + L.changing_settings_warning + "</p>\n<cs-system-admin-permissions-form permission_id=\"" + permission.id + "\" label=\"" + (cs.prepare_attr_value(permission.label)) + "\" group=\"" + (cs.prepare_attr_value(permission.group)) + "\"/>")).on('close', (function(_this) {
        return function() {
          return _this.reload();
        };
      })(this));
    },
    delete_permission: function(e) {
      var permission;
      permission = e.model.permission;
      return cs.ui.confirm("<h3>" + (L.sure_delete_permission(permission.group + '/' + permission.label)) + "</h3>\n<p class=\"cs-block-error cs-text-error\">" + L.changing_settings_warning + "</p>", (function(_this) {
        return function() {
          return $.ajax({
            url: 'api/System/admin/permissions/' + permission.id,
            type: 'delete',
            success: function() {
              cs.ui.notify(L.changes_saved, 'success', 5);
              return _this.splice('permissions', e.model.index, 1);
            }
          });
        };
      })(this));
    }
  });

}).call(this);
