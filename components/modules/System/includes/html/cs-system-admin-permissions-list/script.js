// Generated by CoffeeScript 1.10.0

/**
 * @package    CleverStyle CMS
 * @subpackage System module
 * @category   modules
 * @author     Nazar Mokrynskyi <nazar@mokrynskyi.com>
 * @copyright  Copyright (c) 2015, Nazar Mokrynskyi
 * @license    MIT License, see license.txt
 */

(function() {
  var L;

  L = cs.Language;

  Polymer({
    tooltip_animation: '{animation:true,delay:200}',
    L: L,
    permissions: [],
    created: function() {
      return this.reload();
    },
    reload: function() {
      return $.when($.getJSON('api/System/admin/blocks'), $.getJSON('api/System/admin/permissions')).done((function(_this) {
        return function(blocks, permissions) {
          var group, id, index_to_title, label, labels, permissions_list, ref;
          index_to_title = {};
          blocks[0].forEach(function(block) {
            return index_to_title[block.index] = block.title;
          });
          permissions_list = [];
          ref = permissions[0];
          for (group in ref) {
            labels = ref[group];
            for (label in labels) {
              id = labels[label];
              permissions_list.push({
                id: id,
                group: group,
                label: label,
                description: group === 'Block' ? index_to_title[label] : ''
              });
            }
          }
          return _this.permissions = permissions_list;
        };
      })(this));
    },
    domReady: function() {
      var timeout;
      timeout = null;
      return cs.observe_inserts_on(this.shadowRoot, (function(_this) {
        return function() {
          if (timeout) {
            clearTimeout(timeout);
          }
          return timeout = setTimeout((function() {
            timeout = null;
            return $(_this.shadowRoot).cs().tooltips_inside();
          }), 100);
        };
      })(this));
    },
    add_permission: function() {
      return $.cs.simple_modal("<h3>" + L.adding_permission + "</h3>\n<p class=\"uk-alert uk-alert-danger\">" + L.changing_settings_warning + "</p>\n<cs-system-admin-permissions-form/>").on('hide.uk.modal', (function(_this) {
        return function() {
          return _this.reload();
        };
      })(this));
    },
    edit_permission: function(event, detail, sender) {
      var $sender, index, permission;
      $sender = $(sender);
      index = $sender.closest('[data-permission-index]').data('permission-index');
      permission = this.permissions[index];
      return $.cs.simple_modal("<h3>" + (L.editing_permission(permission.group + '/' + permission.label)) + "</h3>\n<p class=\"uk-alert uk-alert-danger\">" + L.changing_settings_warning + "</p>\n<cs-system-admin-permissions-form permission_id=\"" + permission.id + "\" label=\"" + (cs.prepare_attr_value(permission.label)) + "\" group=\"" + (cs.prepare_attr_value(permission.group)) + "\"/>").on('hide.uk.modal', (function(_this) {
        return function() {
          return _this.reload();
        };
      })(this));
    },
    delete_permission: function(event, detail, sender) {
      var $sender, index, permission;
      $sender = $(sender);
      index = $sender.closest('[data-permission-index]').data('permission-index');
      permission = this.permissions[index];
      return UIkit.modal.confirm("<h3>" + (L.sure_delete_permission(permission.group + '/' + permission.label)) + "</h3>\n<p class=\"uk-alert uk-alert-danger\">" + L.changing_settings_warning + "</p>", (function(_this) {
        return function() {
          return $.ajax({
            url: 'api/System/admin/permissions/' + permission.id,
            type: 'delete',
            success: function() {
              UIkit.notify(L.changes_saved.toString(), 'success');
              return _this.permissions.splice(index, 1);
            }
          });
        };
      })(this));
    }
  });

}).call(this);
